<!DOCTYPE html>
<!-- saved from url=(0069)https://docs.decentraland.org/contributor/runtime/modules/engine_api/ -->
<html lang="en-us" dir="ltr"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="The EngineApi module provides access to the Entity-Component-System framework shared between the World Explorer (which runs the game loop) and individual scenes (which manage their own entities), plus related utilities.
const engine = require(&quot;~system/EngineApi&quot;) This module is the most complex and rich in functionality, and the likeliest to receive updates and extensions. It’s where most of the power of Decentraland resides, since it determines the kind of experiences people can create.">
<meta name="theme-color" content="#FFFFFF">
<meta name="color-scheme" content="light dark"><meta property="og:title" content="EngineApi">
<meta property="og:description" content="The EngineApi module provides access to the Entity-Component-System framework shared between the World Explorer (which runs the game loop) and individual scenes (which manage their own entities), plus related utilities.
const engine = require(&quot;~system/EngineApi&quot;) This module is the most complex and rich in functionality, and the likeliest to receive updates and extensions. It’s where most of the power of Decentraland resides, since it determines the kind of experiences people can create.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://docs.decentraland.org/contributor/runtime/modules/engine_api/"><meta property="og:image" content="https://docs.decentraland.org/images/og-logo.png"><meta property="article:section" content="contributor">
<meta property="article:modified_time" content="2024-04-26T15:50:40-03:00">
<title>EngineApi | Decentraland Documentation</title>
<link rel="manifest" href="https://docs.decentraland.org/manifest.json">
<link rel="icon" href="https://docs.decentraland.org/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="./EngineApi _ Decentraland Documentation_files/book.min.f4a0fa25275edf7eefd0c816f2b982b64e30ef636c0f9b489628b69493e386d8.css" integrity="sha256-9KD6JSde337v0MgW8rmCtk4w72NsD5tIlii2lJPjhtg=" crossorigin="anonymous">
<script type="text/javascript" async="" src="./EngineApi _ Decentraland Documentation_files/z0h94kay"></script><script type="text/javascript" async="" src="./EngineApi _ Decentraland Documentation_files/analytics.min.js.download"></script><script defer="" src="./EngineApi _ Decentraland Documentation_files/lunr.min.js.download"></script>
<script defer="" src="./EngineApi _ Decentraland Documentation_files/en.search.min.6b52c5e340880f4d4309bc4e386aa11630e533e615b71c3010e55438bc701f63.js.download" integrity="sha256-a1LF40CID01DCbxOOGqhFjDlM+YVtxwwEOVUOLxwH2M=" crossorigin="anonymous"></script>
<script>
  !function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","debug","page","once","off","on","addSourceMiddleware","addIntegrationMiddleware","setAnonymousId","addDestinationMiddleware"];analytics.factory=function(e){return function(){var t=Array.prototype.slice.call(arguments);t.unshift(e);analytics.push(t);return analytics}};for(var e=0;e<analytics.methods.length;e++){var key=analytics.methods[e];analytics[key]=analytics.factory(key)}analytics.load=function(key,e){var t=document.createElement("script");t.type="text/javascript";t.async=!0;t.src="https://cdn.segment.com/analytics.js/v1/" + key + "/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(t,n);analytics._loadOptions=e};analytics._writeKey="ZHLrnVct1IQCx7yLeOzxSic7G1Duy0HH";;analytics.SNIPPET_VERSION="4.15.3";
  analytics.load("ZHLrnVct1IQCx7yLeOzxSic7G1Duy0HH");
  analytics.page();
  }}();
</script>
<script defer="" src="./EngineApi _ Decentraland Documentation_files/intercom.min.47bd2edf568b96bf76004cf88a0feac89cc3aa30d7e89a0aaf8fa0e22627387c.js.download" integrity="sha256-R70u31aLlr92AEz4ig/qyJzDqjDX6JoKr4+g4iYnOHw=" crossorigin="anonymous"></script>

</head>
<body dir="ltr">
<input type="checkbox" class="hidden toggle" id="menu-control">
<input type="checkbox" class="hidden toggle" id="toc-control">
<div class="dcl navbar fullscreen" role="navigation">
<div class="ui container">
<div class="dcl navbar-menu">
<div class="ui secondary stackable menu">
<a class="dcl navbar-logo" href="https://decentraland.org/">
<i class="dcl logo"></i>
</a>
<div class="item">
<a href="https://market.decentraland.org/" class="item">Marketplace</a>
<div class="item submenu">
<div class="ui vertical menu">
<a href="https://market.decentraland.org/" class="item">Overview</a>
<a href="https://market.decentraland.org/browse" class="item">Collectibles</a>
<a href="https://market.decentraland.org/lands" class="item">LAND</a>
<a href="https://market.decentraland.org/account" class="item">My Assets</a>
</div>
</div>
</div>
<div class="item">
<a href="https://builder.decentraland.org/" class="item">Builder</a>
<div class="item submenu">
<div class="ui vertical menu">
<a href="https://builder.decentraland.org/" class="item">Overview</a>
<a href="https://builder.decentraland.org/collections" class="item">Collections</a>
<a href="https://builder.decentraland.org/scenes" class="item">Scenes</a>
<a href="https://builder.decentraland.org/land" class="item">Land</a>
<a href="https://builder.decentraland.org/names" class="item">Names</a>
<a href="https://builder.decentraland.org/worlds" class="item">Worlds</a>
</div>
</div>
</div>
<div class="item">
<a href="https://docs.decentraland.org/" class="active item">Docs</a>
<div class="item submenu">
<div class="ui vertical menu">
<a href="https://docs.decentraland.org/player" class="item">Players</a>
<a href="https://docs.decentraland.org/creator" class="item">Content Creators</a>
<a href="https://docs.decentraland.org/contributor" class="item">Contributors</a>
<a href="https://studios.decentraland.org/" class="item">Studios</a>
</div>
</div>
</div>
<div class="item">
<a href="https://places.decentraland.org/" class="item">Places</a>
<div class="item submenu">
<div class="ui vertical menu">
<a href="https://places.decentraland.org/" class="item">Overview</a>
<a href="https://places.decentraland.org/places" class="item">Places</a>
<a href="https://places.decentraland.org/worlds" class="item">Worlds</a>
<a href="https://docs.decentraland.org/creator/places/faq" class="item">FAQ</a>
</div>
</div>
</div>
<div class="item">
<a href="https://events.decentraland.org/" class="item">Events</a>
</div>
<div class="item">
<a href="https://dao.decentraland.org/" class="item">DAO</a>
<div class="item submenu">
<div class="ui vertical menu">
<a href="https://dao.decentraland.org/" class="item">Overview</a>
<a href="https://governance.decentraland.org/" class="item">Governance</a>
<a href="https://governance.decentraland.org/transparency" class="item">Transparency</a>
</div>
</div>
</div>
<div class="item">
<a href="https://decentraland.org/blog" class="item">Blog</a>
</div>
</div>
</div>
</div>
</div>
<script>
  (function(){var e=document.querySelectorAll(".dcl.navbar .dcl.navbar-menu .ui.menu > div.item");e.forEach(e=>{e.querySelectorAll("a.item").forEach(t=>{var n=e.querySelector("a.item");t.addEventListener("click",function(e){window.analytics&&window.analytics.track("Clicked on navbar",{section:n.textContent.toLowerCase(),submenu:n.textContent!==e.target.textContent?e.target.textContent.toLowerCase():void 0})})})})})()
</script>
<div class="tabs-header">
<div class="dcl tabs ">
<div class="ui container">
<div class="dcl tab active" style="border-color: transparent">
<a aria-current="page" class="tabs-navigation" href="https://docs.decentraland.org/player">Players</a>
</div>
<div class="dcl tab active" style="border-color: transparent">
<a aria-current="page" class="tabs-navigation" href="https://docs.decentraland.org/creator">Content Creators</a>
</div>
<div class="dcl tab active">
<a aria-current="page" class="tabs-navigation" href="https://docs.decentraland.org/contributor">Contributors</a>
<div class="active-bar" style="border-color: #EE834A;"></div>
<style>
                :root {
                  --primary: #EE834A;
                }
              </style>
</div>
<div class="book-search">
<div id="search-overlay" class="hidden"></div>
<div id="book-search-input">
<img src="./EngineApi _ Decentraland Documentation_files/search.svg" class="book-icon" alt="Search">
<input type="text" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/">
</div>
<div class="book-search-spinner hidden"></div>
<div id="book-search-results">
<div id="book-search-hits" class="hidden" tabindex="0">
<ul id="book-search-list"></ul>
</div>
</div>
</div>
</div>
</div>
</div>
<main class="container flex">
<aside class="book-menu sidebar">
<div class="book-menu-content">
<nav>
<ul>
<li>
<span>Introduction</span>
<ul>
<li>
<a href="https://docs.decentraland.org/contributor/introduction/welcome/" class="">Welcome!</a>
</li>
<li>
<a href="https://docs.decentraland.org/contributor/introduction/architecture/" class="">Architecture</a>
</li>
</ul>
</li>
<li>
<span>Identity</span>
<ul>
<li>
<a href="https://docs.decentraland.org/contributor/auth/authchain/" class="">Authentication Chain</a>
</li>
<li>
<a href="https://docs.decentraland.org/contributor/auth/signed-fetch/" class="">Signed Fetch</a>
</li>
</ul>
</li>
<li>
<span>Content</span>
<ul>
<li>
<a href="https://docs.decentraland.org/contributor/content/overview/" class="">Overview</a>
</li>
<li>
<a href="https://docs.decentraland.org/contributor/content/filesystem/" class="">File System</a>
</li>
<li>
<a href="https://docs.decentraland.org/contributor/content/entities/" class="">Entities</a>
</li>
<li>
<a href="https://docs.decentraland.org/contributor/content/pointers/" class="">Pointers</a>
</li>
<li>
<a href="https://docs.decentraland.org/contributor/content/snapshots/" class="">Snapshots</a>
</li>
<li>
<a href="https://docs.decentraland.org/contributor/content/collections/" class="">Collections</a>
</li>
<li>
<input type="checkbox" id="section-78d857344d9976cb2d2de1aa922ff1d0" class="toggle">
<label for="section-78d857344d9976cb2d2de1aa922ff1d0" class="flex justify-between">
<a role="button" class="">Entity Types</a>
</label>
<ul>
<li>
<a href="https://docs.decentraland.org/contributor/content/entity-types/scenes/" class="">Scenes</a>
</li>
<li>
<a href="https://docs.decentraland.org/contributor/content/entities-types/outfits/" class="">Outfits</a>
</li>
<li>
<a href="https://docs.decentraland.org/contributor/content/entities-types/profiles/" class="">Profiles</a>
</li>
<li>
<a href="https://docs.decentraland.org/contributor/content/entity-types/wearables/" class="">Wearables</a>
</li>
<li>
<a href="https://docs.decentraland.org/contributor/content/entity-types/emotes/" class="">Emotes</a>
</li>
<li>
<a href="https://docs.decentraland.org/contributor/content/entity-types/stores/" class="">Stores</a>
</li>
</ul>
</li>
<li>
<a href="https://docs.decentraland.org/contributor/content/practice/" class="">Practice</a>
<ul>
</ul>
</li>
</ul>
</li>
<li>
<span>Scene Runtime</span>
<ul>
<li>
<a href="https://docs.decentraland.org/contributor/runtime/overview/" class="">Overview</a>
</li>
<li>
<a href="https://docs.decentraland.org/contributor/runtime/globals/" class="">Globals</a>
</li>
<li>
<a href="https://docs.decentraland.org/contributor/runtime/execution/" class="">Execution</a>
</li>
<li>
<a href="https://docs.decentraland.org/contributor/runtime/permissions/" class="">Permissions</a>
</li>
<li>
<a href="https://docs.decentraland.org/contributor/runtime/entities/" class="">Basic Entities</a>
</li>
<li>
<a href="https://docs.decentraland.org/contributor/runtime/components/" class="">Basic Components</a>
</li>
<li>
<input type="checkbox" id="section-10168aa810fc3bbfe8a69b8fd3fa7a80" class="toggle" checked="">
<label for="section-10168aa810fc3bbfe8a69b8fd3fa7a80" class="flex justify-between">
<a role="button" class="">Modules</a>
</label>
<ul>
<li>
<a href="https://docs.decentraland.org/contributor/runtime/modules/engine_api/" class="active">EngineApi</a>
</li>
<li>
<a href="https://docs.decentraland.org/contributor/runtime/modules/restricted_actions/" class="">RestrictedActions</a>
</li>
<li>
<a href="https://docs.decentraland.org/contributor/runtime/modules/user_identity/" class="">UserIdentity</a>
</li>
<li>
<a href="https://docs.decentraland.org/contributor/runtime/modules/signed_fetch/" class="">SignedFetch</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<span>Communications</span>
<ul>
<li>
<a href="https://docs.decentraland.org/contributor/comms/overview/" class="">Overview</a>
</li>
<li>
<a href="https://docs.decentraland.org/contributor/comms/main/" class="">MAIN Realm</a>
</li>
<li>
<a href="https://docs.decentraland.org/contributor/comms/archipelago/" class="">Archipelago</a>
</li>
<li>
<a href="https://docs.decentraland.org/contributor/comms/messages/" class="">Messages</a>
</li>
<li>
<a href="https://docs.decentraland.org/contributor/comms/transports/" class="">Transports</a>
</li>
<li>
<input type="checkbox" id="section-fd25a60f0b8f77e70711dd8d5ea6ec37" class="toggle">
<label for="section-fd25a60f0b8f77e70711dd8d5ea6ec37" class="flex justify-between">
<a role="button" class="">Transport Types</a>
</label>
<ul>
<li>
<a href="https://docs.decentraland.org/contributor/comms/transport-types/livekit/" class="">LiveKit</a>
</li>
<li>
<a href="https://docs.decentraland.org/contributor/comms/transport-types/websocket/" class="">Websocket</a>
</li>
<li>
<a href="https://docs.decentraland.org/contributor/comms/transport-types/signed-login/" class="">Signed Login</a>
</li>
<li>
<a href="https://docs.decentraland.org/contributor/comms/transport-types/offline/" class="">Offline</a>
</li>
<li>
<a href="https://docs.decentraland.org/contributor/comms/transport-types/simulator/" class="">Simulator</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<span>Catalyst Nodes</span>
<ul>
<li>
<a href="https://docs.decentraland.org/contributor/catalyst/glossary/" class="">Glossary</a>
</li>
<li>
<a href="https://docs.decentraland.org/contributor/catalyst/realm-selection/" class="">Realm Selection</a>
</li>
</ul>
</li>
<li>
<span>Explorer Renderer</span>
<ul>
<li>
<input type="checkbox" id="section-b9181de4c3c755fb3fc9f6afcd6fedde" class="toggle">
<label for="section-b9181de4c3c755fb3fc9f6afcd6fedde" class="flex justify-between">
<a role="button" class="">Components</a>
</label>
<ul>
<li>
<a href="https://docs.decentraland.org/contributor/unity-renderer/components/how-to-create-components/" class="">Component Creation</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<span>Social Service</span>
<ul>
<li>
<a href="https://docs.decentraland.org/contributor/social-service/overview/" class="">Overview</a>
</li>
<li>
<a href="https://docs.decentraland.org/contributor/social-service/js-client/" class="">Javascript Client</a>
</li>
<li>
<a href="https://docs.decentraland.org/contributor/social-service/login/" class="">Login</a>
</li>
<li>
<a href="https://docs.decentraland.org/contributor/social-service/get-friends/" class="">Get friendships</a>
</li>
<li>
<a href="https://docs.decentraland.org/contributor/social-service/put-friends/" class="">Act on events and users</a>
</li>
</ul>
</li>
<li>
<span>Tutorials</span>
<ul>
<li>
<a href="https://docs.decentraland.org/contributor/tutorials/how-to-create-new-entity-type/" class="">New entity type</a>
</li>
<li>
<a href="https://docs.decentraland.org/contributor/tutorials/how-to-run-a-catalyst/" class="">Run a Catalyst Node</a>
</li>
</ul>
</li>
</ul>
</nav>
<script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>
</div>
</aside>
<div class="book-page">
<header class="book-header">
<div class="flex align-center justify-between">
<label for="menu-control">
<img src="./EngineApi _ Decentraland Documentation_files/menu.svg" class="book-icon" alt="Menu">
</label>
<strong>EngineApi</strong>
<label for="toc-control">
</label>
</div>
</header>
<article class="markdown">
<h1>EngineApi</h1><p>The <code>EngineApi</code> module provides access to the Entity-Component-System framework shared between the World Explorer (which runs the game loop) and individual scenes (which manage their own entities), plus related utilities.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">engine</span> <span class="o">=</span> <span class="kr">require</span><span class="p">(</span><span class="s2">"~system/EngineApi"</span><span class="p">)</span>
</span></span></code></pre></div><p>This module is the most complex and rich in functionality, and the likeliest to receive updates and extensions. It’s where most of the power of Decentraland resides, since it determines the kind of experiences people can create.</p>
<p>This module contains the following methods:</p>
<ul>
<li><a href="https://docs.decentraland.org/contributor/runtime/modules/engine_api/#crdtSendToRenderer">
<code>function crdtSendToRenderer</code>
</a></li>
<li><a href="https://docs.decentraland.org/contributor/runtime/modules/engine_api/#crdtGetState">
<code>function crdtGetState</code>
</a></li>
</ul>
<h2 id="introduction">
Introduction
<a class="anchor" href="https://docs.decentraland.org/contributor/runtime/modules/engine_api/#introduction">#</a>
</h2>
<p>The <code>EngineApi</code> module is designed to synchronize the state of the world between the Explorer and the scene by exchanging updates, events and commands. It implements an extensible message protocol that allows scenes to, among other things:</p>
<ul>
<li>Create and destroy entities.</li>
<li>Attach, update, and remove components.</li>
<li>Cast rays in the 3D environment and detect hits.</li>
<li>Receive events such as input from the player.</li>
</ul>
<div class="goat svg-container ">
<svg xmlns="http://www.w3.org/2000/svg" font-family="Menlo,Lucida Console,monospace" viewBox="0 0 512 233">
<g transform="translate(8,16)">
<path d="M 0,0 L 440,0" fill="none" stroke="currentColor"></path>
<path d="M 24,80 L 96,80" fill="none" stroke="currentColor"></path>
<path d="M 320,80 L 424,80" fill="none" stroke="currentColor"></path>
<path d="M 104,96 L 200,96" fill="none" stroke="currentColor"></path>
<path d="M 208,96 L 320,96" fill="none" stroke="currentColor"></path>
<path d="M 344,112 L 392,112" fill="none" stroke="currentColor"></path>
<path d="M 96,144 L 192,144" fill="none" stroke="currentColor"></path>
<path d="M 200,144 L 312,144" fill="none" stroke="currentColor"></path>
<path d="M 344,160 L 408,160" fill="none" stroke="currentColor"></path>
<path d="M 24,176 L 96,176" fill="none" stroke="currentColor"></path>
<path d="M 320,176 L 424,176" fill="none" stroke="currentColor"></path>
<path d="M 0,208 L 440,208" fill="none" stroke="currentColor"></path>
<path d="M 0,0 L 0,208" fill="none" stroke="currentColor"></path>
<path d="M 24,80 L 24,176" fill="none" stroke="currentColor"></path>
<path d="M 96,80 L 96,144" fill="none" stroke="currentColor"></path>
<path d="M 96,144 L 96,176" fill="none" stroke="currentColor"></path>
<path d="M 200,64 L 200,96" fill="none" stroke="currentColor"></path>
<path d="M 200,96 L 200,144" fill="none" stroke="currentColor"></path>
<path d="M 200,144 L 200,176" fill="none" stroke="currentColor"></path>
<path d="M 320,80 L 320,96" fill="none" stroke="currentColor"></path>
<path d="M 320,96 L 320,176" fill="none" stroke="currentColor"></path>
<path d="M 344,112 L 344,160" fill="none" stroke="currentColor"></path>
<path d="M 408,128 L 408,160" fill="none" stroke="currentColor"></path>
<path d="M 424,80 L 424,176" fill="none" stroke="currentColor"></path>
<path d="M 440,0 L 440,208" fill="none" stroke="currentColor"></path>
<polygon points="112.000000,96.000000 100.000000,90.400002 100.000000,101.599998" fill="currentColor" transform="rotate(180.000000, 104.000000, 96.000000)"></polygon>
<polygon points="200.000000,144.000000 188.000000,138.399994 188.000000,149.600006" fill="currentColor" transform="rotate(0.000000, 192.000000, 144.000000)"></polygon>
<polygon points="216.000000,96.000000 204.000000,90.400002 204.000000,101.599998" fill="currentColor" transform="rotate(180.000000, 208.000000, 96.000000)"></polygon>
<polygon points="320.000000,144.000000 308.000000,138.399994 308.000000,149.600006" fill="currentColor" transform="rotate(0.000000, 312.000000, 144.000000)"></polygon>
<path d="M 392,112 A 16,16 0 0,1 408,128" fill="none" stroke="currentColor"></path>
<text text-anchor="middle" x="16" y="20" fill="currentColor" style="font-size:1em">W</text>
<text text-anchor="middle" x="24" y="20" fill="currentColor" style="font-size:1em">o</text>
<text text-anchor="middle" x="32" y="20" fill="currentColor" style="font-size:1em">r</text>
<text text-anchor="middle" x="40" y="20" fill="currentColor" style="font-size:1em">l</text>
<text text-anchor="middle" x="40" y="148" fill="currentColor" style="font-size:1em">E</text>
<text text-anchor="middle" x="48" y="20" fill="currentColor" style="font-size:1em">d</text>
<text text-anchor="middle" x="48" y="116" fill="currentColor" style="font-size:1em">G</text>
<text text-anchor="middle" x="48" y="148" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="56" y="116" fill="currentColor" style="font-size:1em">a</text>
<text text-anchor="middle" x="56" y="148" fill="currentColor" style="font-size:1em">g</text>
<text text-anchor="middle" x="64" y="20" fill="currentColor" style="font-size:1em">E</text>
<text text-anchor="middle" x="64" y="116" fill="currentColor" style="font-size:1em">m</text>
<text text-anchor="middle" x="64" y="148" fill="currentColor" style="font-size:1em">i</text>
<text text-anchor="middle" x="72" y="20" fill="currentColor" style="font-size:1em">x</text>
<text text-anchor="middle" x="72" y="116" fill="currentColor" style="font-size:1em">e</text>
<text text-anchor="middle" x="72" y="148" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="80" y="20" fill="currentColor" style="font-size:1em">p</text>
<text text-anchor="middle" x="80" y="148" fill="currentColor" style="font-size:1em">e</text>
<text text-anchor="middle" x="88" y="20" fill="currentColor" style="font-size:1em">l</text>
<text text-anchor="middle" x="96" y="20" fill="currentColor" style="font-size:1em">o</text>
<text text-anchor="middle" x="104" y="20" fill="currentColor" style="font-size:1em">r</text>
<text text-anchor="middle" x="112" y="20" fill="currentColor" style="font-size:1em">e</text>
<text text-anchor="middle" x="120" y="20" fill="currentColor" style="font-size:1em">r</text>
<text text-anchor="middle" x="128" y="132" fill="currentColor" style="font-size:1em">E</text>
<text text-anchor="middle" x="136" y="132" fill="currentColor" style="font-size:1em">v</text>
<text text-anchor="middle" x="144" y="132" fill="currentColor" style="font-size:1em">e</text>
<text text-anchor="middle" x="152" y="132" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="160" y="52" fill="currentColor" style="font-size:1em">[</text>
<text text-anchor="middle" x="160" y="132" fill="currentColor" style="font-size:1em">t</text>
<text text-anchor="middle" x="168" y="52" fill="currentColor" style="font-size:1em">E</text>
<text text-anchor="middle" x="168" y="132" fill="currentColor" style="font-size:1em">s</text>
<text text-anchor="middle" x="176" y="52" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="184" y="52" fill="currentColor" style="font-size:1em">g</text>
<text text-anchor="middle" x="192" y="52" fill="currentColor" style="font-size:1em">i</text>
<text text-anchor="middle" x="200" y="52" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="208" y="52" fill="currentColor" style="font-size:1em">e</text>
<text text-anchor="middle" x="224" y="52" fill="currentColor" style="font-size:1em">A</text>
<text text-anchor="middle" x="232" y="52" fill="currentColor" style="font-size:1em">P</text>
<text text-anchor="middle" x="232" y="116" fill="currentColor" style="font-size:1em">C</text>
<text text-anchor="middle" x="240" y="52" fill="currentColor" style="font-size:1em">I</text>
<text text-anchor="middle" x="240" y="116" fill="currentColor" style="font-size:1em">o</text>
<text text-anchor="middle" x="248" y="52" fill="currentColor" style="font-size:1em">]</text>
<text text-anchor="middle" x="248" y="116" fill="currentColor" style="font-size:1em">m</text>
<text text-anchor="middle" x="256" y="116" fill="currentColor" style="font-size:1em">m</text>
<text text-anchor="middle" x="264" y="116" fill="currentColor" style="font-size:1em">a</text>
<text text-anchor="middle" x="272" y="116" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="280" y="116" fill="currentColor" style="font-size:1em">d</text>
<text text-anchor="middle" x="288" y="116" fill="currentColor" style="font-size:1em">s</text>
<text text-anchor="middle" x="344" y="100" fill="currentColor" style="font-size:1em">R</text>
<text text-anchor="middle" x="352" y="100" fill="currentColor" style="font-size:1em">u</text>
<text text-anchor="middle" x="360" y="100" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="360" y="132" fill="currentColor" style="font-size:1em">S</text>
<text text-anchor="middle" x="368" y="100" fill="currentColor" style="font-size:1em">t</text>
<text text-anchor="middle" x="368" y="132" fill="currentColor" style="font-size:1em">c</text>
<text text-anchor="middle" x="376" y="100" fill="currentColor" style="font-size:1em">i</text>
<text text-anchor="middle" x="376" y="132" fill="currentColor" style="font-size:1em">e</text>
<text text-anchor="middle" x="384" y="100" fill="currentColor" style="font-size:1em">m</text>
<text text-anchor="middle" x="384" y="132" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="392" y="100" fill="currentColor" style="font-size:1em">e</text>
<text text-anchor="middle" x="392" y="132" fill="currentColor" style="font-size:1em">e</text>
</g>
</svg>
</div>
<div class="ui blue message">
<div class="content">
<p>The <code>EngineApi</code> module is undergoing renovations. If you go to the source definitions, you will find legacy methods that are no longer used or can be implemented as no-ops in the latest version (more on this below).</p>
</div>
</div>
<h2 id="ecs-framework">
ECS Framework
<a class="anchor" href="https://docs.decentraland.org/contributor/runtime/modules/engine_api/#ecs-framework">#</a>
</h2>
<p>With the <code>EngineApi</code> module comes a generic and extensible implementation of a shared ECS framework, which allows both scenes and the game engine itself to create entities, attach components and update their states.</p>
<p>Changes made from either side are reflected in the other by exchanging messages. The mechanism used (<a href="https://docs.decentraland.org/contributor/runtime/modules/engine_api/#synchronization">
see below
</a>) ensures that both parties agree on the order of any updates and reach eventual consistency about the state of the world.</p>
<p>The World Explorer implements a well-known set of basic components (positions, shapes, textures, media and more), and knows how to deserialize and apply changes to their state when it receives an update. Scenes using the <a href="https://docs.decentraland.org/creator" target="_blank">
SDK
</a> also have utilities to create custom components, but those are entirely managed by the scene (not synchronized) and thus outside the scope of the protocol.</p>
<div class="ui blue message">
<div class="content">
<p>Most scenes use the Decentraland SDK, which encapsulates the <code>EngineApi</code> module and offers a much nicer, higher-level interface for content developers. Scenes that directly access the messaging protocol in this module are extremely rare.</p>
</div>
</div>
<h3 id="identifying">
Identifying Entities
<a class="anchor" href="https://docs.decentraland.org/contributor/runtime/modules/engine_api/#identifying">#</a>
</h3>
<p>Entity IDs are plain integers starting with <code>0</code>.</p>
<p>By protocol, IDs below <code>512</code> are reserved for the World Explorer, and thus invalid for scene-created entities. Numbers <code>0</code>, <code>1</code> and <code>2</code> are actually in use (see <a href="https://docs.decentraland.org/contributor/runtime/entities/">
basic entities
</a>), with the rest of the range available for future extensions.</p>
<p>Each scene has its own private range of IDs, which the Explorer can transparently map to a global identifier among all entities in the game engine.</p>
<p>Over time, as entities are created and deleted, it’s perfectly valid to reuse IDs that were previously freed – indeed, this may be required for perfomance reasons (<a href="https://docs.decentraland.org/contributor/runtime/modules/engine_api/crdtStateDeleteEntities">
see below
</a>).</p>
<h3 id="synchronization">
Synchronization
<a class="anchor" href="https://docs.decentraland.org/contributor/runtime/modules/engine_api/#synchronization">#</a>
</h3>
<p>Both the World Explorer and the scene must manage a set of shared entities and components, where updates come from both sides in an asynchronous fashion. Without additional measures, their versions of the state of the world can (and will) end up being different.</p>
<p>To prevent this, a CRDT (<a href="https://en.wikipedia.org/wiki/Conflict-free_replicated_data_type" target="_blank">
conflict-free replicated data type
</a>) is used to reach an agreement between both parties by exchanging messages with updates. This offers a number of advantages:</p>
<ul>
<li>Both parties can update the state independently and concurrently.</li>
<li>Conflicts are managed by a shared resolution strategy applied locally by both parties.</li>
<li>Both parties are guaranteed to converge to a shared, identical state.</li>
<li>Besides a small overhead in message size, no additional coordination or messaging round-trips are required.</li>
</ul>
<div class="ui blue message">
<div class="content">
<p>This page explains the use of the CRDT to synchronize state between a locally running scene and the game engine, but the real potential of this mechanism lies in multiplayer scenarios. Using this protocol, players can coordinate their game state and share the same experience.</p>
</div>
</div>
<p>For this to work, all messages must be commutative and idempotent. Out-of-order messages can be applied even if a supposedly intermediate update was not received yet, and equal messages can be re-processed without breaking consistency.</p>
<p>Let’s revisit the architectural diagram above, now focusing on the CRDT:</p>
<div class="goat svg-container ">
<svg xmlns="http://www.w3.org/2000/svg" font-family="Menlo,Lucida Console,monospace" viewBox="0 0 512 217">
<g transform="translate(8,16)">
<path d="M 0,0 L 448,0" fill="none" stroke="currentColor"></path>
<path d="M 16,48 L 128,48" fill="none" stroke="currentColor"></path>
<path d="M 320,48 L 416,48" fill="none" stroke="currentColor"></path>
<path d="M 40,80 L 104,80" fill="none" stroke="currentColor"></path>
<path d="M 344,80 L 408,80" fill="none" stroke="currentColor"></path>
<path d="M 104,96 L 128,96" fill="none" stroke="currentColor"></path>
<path d="M 128,96 L 320,96" fill="none" stroke="currentColor"></path>
<path d="M 320,96 L 336,96" fill="none" stroke="currentColor"></path>
<path d="M 112,128 L 128,128" fill="none" stroke="currentColor"></path>
<path d="M 128,128 L 320,128" fill="none" stroke="currentColor"></path>
<path d="M 320,128 L 344,128" fill="none" stroke="currentColor"></path>
<path d="M 40,144 L 104,144" fill="none" stroke="currentColor"></path>
<path d="M 344,144 L 408,144" fill="none" stroke="currentColor"></path>
<path d="M 16,176 L 128,176" fill="none" stroke="currentColor"></path>
<path d="M 320,176 L 432,176" fill="none" stroke="currentColor"></path>
<path d="M 0,192 L 448,192" fill="none" stroke="currentColor"></path>
<path d="M 0,0 L 0,192" fill="none" stroke="currentColor"></path>
<path d="M 16,48 L 16,176" fill="none" stroke="currentColor"></path>
<path d="M 40,80 L 40,144" fill="none" stroke="currentColor"></path>
<path d="M 104,80 L 104,96" fill="none" stroke="currentColor"></path>
<path d="M 104,96 L 104,144" fill="none" stroke="currentColor"></path>
<path d="M 128,48 L 128,96" fill="none" stroke="currentColor"></path>
<path d="M 128,96 L 128,128" fill="none" stroke="currentColor"></path>
<path d="M 128,128 L 128,176" fill="none" stroke="currentColor"></path>
<path d="M 320,48 L 320,96" fill="none" stroke="currentColor"></path>
<path d="M 320,96 L 320,128" fill="none" stroke="currentColor"></path>
<path d="M 320,128 L 320,176" fill="none" stroke="currentColor"></path>
<path d="M 344,80 L 344,128" fill="none" stroke="currentColor"></path>
<path d="M 344,128 L 344,144" fill="none" stroke="currentColor"></path>
<path d="M 408,80 L 408,144" fill="none" stroke="currentColor"></path>
<path d="M 432,64 L 432,176" fill="none" stroke="currentColor"></path>
<path d="M 448,0 L 448,192" fill="none" stroke="currentColor"></path>
<polygon points="120.000000,128.000000 108.000000,122.400002 108.000000,133.600006" fill="currentColor" transform="rotate(180.000000, 112.000000, 128.000000)"></polygon>
<polygon points="344.000000,96.000000 332.000000,90.400002 332.000000,101.599998" fill="currentColor" transform="rotate(0.000000, 336.000000, 96.000000)"></polygon>
<path d="M 416,48 A 16,16 0 0,1 432,64" fill="none" stroke="currentColor"></path>
<text text-anchor="middle" x="16" y="20" fill="currentColor" style="font-size:1em">W</text>
<text text-anchor="middle" x="24" y="20" fill="currentColor" style="font-size:1em">o</text>
<text text-anchor="middle" x="32" y="20" fill="currentColor" style="font-size:1em">r</text>
<text text-anchor="middle" x="32" y="68" fill="currentColor" style="font-size:1em">G</text>
<text text-anchor="middle" x="40" y="20" fill="currentColor" style="font-size:1em">l</text>
<text text-anchor="middle" x="40" y="68" fill="currentColor" style="font-size:1em">a</text>
<text text-anchor="middle" x="48" y="20" fill="currentColor" style="font-size:1em">d</text>
<text text-anchor="middle" x="48" y="68" fill="currentColor" style="font-size:1em">m</text>
<text text-anchor="middle" x="56" y="68" fill="currentColor" style="font-size:1em">e</text>
<text text-anchor="middle" x="56" y="116" fill="currentColor" style="font-size:1em">C</text>
<text text-anchor="middle" x="64" y="20" fill="currentColor" style="font-size:1em">E</text>
<text text-anchor="middle" x="64" y="116" fill="currentColor" style="font-size:1em">R</text>
<text text-anchor="middle" x="72" y="20" fill="currentColor" style="font-size:1em">x</text>
<text text-anchor="middle" x="72" y="68" fill="currentColor" style="font-size:1em">E</text>
<text text-anchor="middle" x="72" y="116" fill="currentColor" style="font-size:1em">D</text>
<text text-anchor="middle" x="80" y="20" fill="currentColor" style="font-size:1em">p</text>
<text text-anchor="middle" x="80" y="68" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="80" y="116" fill="currentColor" style="font-size:1em">T</text>
<text text-anchor="middle" x="88" y="20" fill="currentColor" style="font-size:1em">l</text>
<text text-anchor="middle" x="88" y="68" fill="currentColor" style="font-size:1em">g</text>
<text text-anchor="middle" x="96" y="20" fill="currentColor" style="font-size:1em">o</text>
<text text-anchor="middle" x="96" y="68" fill="currentColor" style="font-size:1em">i</text>
<text text-anchor="middle" x="104" y="20" fill="currentColor" style="font-size:1em">r</text>
<text text-anchor="middle" x="104" y="68" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="112" y="20" fill="currentColor" style="font-size:1em">e</text>
<text text-anchor="middle" x="112" y="68" fill="currentColor" style="font-size:1em">e</text>
<text text-anchor="middle" x="120" y="20" fill="currentColor" style="font-size:1em">r</text>
<text text-anchor="middle" x="176" y="116" fill="currentColor" style="font-size:1em">S</text>
<text text-anchor="middle" x="184" y="116" fill="currentColor" style="font-size:1em">y</text>
<text text-anchor="middle" x="192" y="116" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="200" y="116" fill="currentColor" style="font-size:1em">c</text>
<text text-anchor="middle" x="216" y="116" fill="currentColor" style="font-size:1em">P</text>
<text text-anchor="middle" x="224" y="116" fill="currentColor" style="font-size:1em">r</text>
<text text-anchor="middle" x="232" y="116" fill="currentColor" style="font-size:1em">o</text>
<text text-anchor="middle" x="240" y="116" fill="currentColor" style="font-size:1em">t</text>
<text text-anchor="middle" x="248" y="116" fill="currentColor" style="font-size:1em">o</text>
<text text-anchor="middle" x="256" y="116" fill="currentColor" style="font-size:1em">c</text>
<text text-anchor="middle" x="264" y="116" fill="currentColor" style="font-size:1em">o</text>
<text text-anchor="middle" x="272" y="116" fill="currentColor" style="font-size:1em">l</text>
<text text-anchor="middle" x="352" y="68" fill="currentColor" style="font-size:1em">S</text>
<text text-anchor="middle" x="360" y="68" fill="currentColor" style="font-size:1em">c</text>
<text text-anchor="middle" x="360" y="116" fill="currentColor" style="font-size:1em">C</text>
<text text-anchor="middle" x="368" y="68" fill="currentColor" style="font-size:1em">e</text>
<text text-anchor="middle" x="368" y="116" fill="currentColor" style="font-size:1em">R</text>
<text text-anchor="middle" x="376" y="68" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="376" y="116" fill="currentColor" style="font-size:1em">D</text>
<text text-anchor="middle" x="384" y="68" fill="currentColor" style="font-size:1em">e</text>
<text text-anchor="middle" x="384" y="116" fill="currentColor" style="font-size:1em">T</text>
</g>
</svg>
</div>
<p>The implementation of the CRDT synchronization mechanism consists of three parts:</p>
<ol>
<li>An internal representation of the state of all entities and components.</li>
<li>A conflict resolution strategy to choose between competing states.</li>
<li>A messaging protocol to communicate and process updates to the state.</li>
</ol>
<h4 id="crdtState">
CRDT State
<a class="anchor" href="https://docs.decentraland.org/contributor/runtime/modules/engine_api/#crdtState">#</a>
</h4>
<p>The CRDT holds the state of all components for all their attached entities, and can be stored in a mapping of components to timestamped states for each entity. In pseudocode:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="c1">// The (completely generic) state of a component for a specific entity, at a point in time:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">type</span> <span class="nx">EntityComponentState</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">timestamp</span>: <span class="kt">number</span><span class="p">,</span> <span class="nx">state</span>: <span class="kt">byte</span><span class="p">[]</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// The state of a component for all attached entities:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">type</span> <span class="nx">ComponentState</span> <span class="o">=</span> <span class="nx">Map</span><span class="p">&lt;</span><span class="nt">EntityId</span><span class="err">,</span> <span class="na">EntityComponentState</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// The entire state of the CRDT:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">type</span> <span class="nx">CRDTState</span> <span class="o">=</span> <span class="nx">Map</span><span class="p">&lt;</span><span class="nt">ComponentId</span><span class="err">,</span> <span class="na">ComponentState</span><span class="p">&gt;</span>
</span></span></code></pre></div><p>Timestamps aren’t actually Unix-style timestamps. They are a type of incremental counter to sequence updates, with no relation to clock time. More on this <a href="https://docs.decentraland.org/contributor/runtime/modules/engine_api/#timestamps">
below
</a>.</p>
<div id="crdtStateAutoCreate"></div>
<p>Since the CRDT layer doesn’t know (or need to know) all available components, the initial state is an empty map. Entries are created on-the-fly when operations involve a <code>ComponentId</code> or <code>EntityId</code> that was not already mapped. When an entity is removed, the associated state is deleted from all components.</p>
<p>Let’s illustrate this with some more pseudocode.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">crdtState</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">()</span> <span class="c1">// empty, we'll automatically make room for new components and entities
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">putEntityComponentState</span><span class="p">(</span><span class="nx">componentId</span><span class="p">,</span> <span class="nx">entityId</span><span class="p">,</span> <span class="nx">entityComponentState</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// If this component is not known yet, add it:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">crdtState</span><span class="p">[</span><span class="nx">componentId</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">crdtState</span><span class="p">[</span><span class="nx">componentId</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// If this entity has no state for this component, add it and be done:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">crdtState</span><span class="p">[</span><span class="nx">componentId</span><span class="p">][</span><span class="nx">entityId</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">shouldCreate</span><span class="p">(</span><span class="nx">entityId</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">crdtState</span><span class="p">[</span><span class="nx">componentId</span><span class="p">][</span><span class="nx">entityId</span><span class="p">]</span> <span class="o">=</span> <span class="nx">entityComponentState</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// At this point, we have two competing states. The one we just received is not necessarily the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// one that should be kept. We need to decide.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">const</span> <span class="nx">existingEntityComponentState</span> <span class="o">=</span> <span class="nx">crdtState</span><span class="p">[</span><span class="nx">componentId</span><span class="p">][</span><span class="nx">entityId</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Only if the rules of conflict resolution say so (more on this later), replace the state:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">shouldReplace</span><span class="p">(</span><span class="nx">entityComponentState</span><span class="p">,</span> <span class="nx">existingEntityComponentState</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">crdtState</span><span class="p">[</span><span class="nx">componentId</span><span class="p">][</span><span class="nx">entityId</span><span class="p">]</span> <span class="o">=</span> <span class="nx">entityComponentState</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The pseudocode above (if translated to actual code) is obviously incomplete and sub-optimal. In particular, it’s missing the definition of <code>shouldCreate</code> and <code>shouldReplace</code>, which encapsulate the conflict resolution strategy. These have requirements:</p>
<ul>
<li><code>shouldCreate</code> must add new entities, but refuse to re-create deleted entities.</li>
<li><code>shouldReplace</code> must prefer to keep states that have greater timestamps (with some edge cases).</li>
</ul>
<div id="crdtStateDeleteEntities"></div>
<p>To support the <code>shouldCreate</code> requirement, you’ll want to keep track of deleted entity IDs, in order to ignore any future state updates for those. Let’s see this in more pseudocode:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">crdtDeletedEntities</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">shouldCreate</span><span class="p">(</span><span class="nx">entityId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="o">!</span><span class="nx">crdtDeletedEntities</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">entityId</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">deleteEntity</span><span class="p">(</span><span class="nx">entityId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Mark this entity as deleted:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">crdtDeletedEntities</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">entityId</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Delete the state for this entity in every component:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="nx">componentState</span> <span class="k">of</span> <span class="nx">crdtState</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">delete</span> <span class="nx">componentState</span><span class="p">[</span><span class="nx">entityId</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="ui blue message">
<div class="content">
<p></p><p>Note that, in the naive implementation above, the set of deleted entities will only grow. In scenes that quickly recycle entities, this can lead to an explosion in memory usage.</p>
<p>To avoid this, the Foundation’s explorer employs a generational index to reuse IDs in a finite numerical space, limiting the amount of memory required to keep track of both active and deleted entities.</p>
<p></p>
</div>
</div>
<p>As for the <code>shouldReplace</code> requirement, see <a href="https://docs.decentraland.org/contributor/runtime/modules/engine_api/#crdtConflicts">
conflict resolution
</a> below.</p>
<h4 id="timestamps">
Timestamps
<a class="anchor" href="https://docs.decentraland.org/contributor/runtime/modules/engine_api/#timestamps">#</a>
</h4>
<p>As mentioned above, when talking about CRDT timestamps we’re not referring to actual Unix timestamps for a point in time. Instead, a <a href="https://en.wikipedia.org/wiki/Lamport_timestamp" target="_blank">
Lamport timestamp
</a> (a special type of shared incremental counter) is used to keep track of the sequence of events by both parties.</p>
<p>The value of this counter is updated according to these rules:</p>
<ol>
<li>Initialize the local counter to <code>0</code>.</li>
<li>Before sending a message to remote parties, increment the local counter.</li>
<li>After receiving a message from a remote party, set the local counter to the maximum between its value and the received value, plus <code>1</code>.</li>
</ol>
<p>In pseudocode:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">localTimestamp</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">sendState</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">send</span><span class="p">({</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">timestamp</span><span class="o">:</span> <span class="o">++</span><span class="nx">localTimestamp</span> <span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">receiveState() {</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">timestamp</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">receive</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="nx">localTimestamp</span> <span class="o">=</span> <span class="nx">max</span><span class="p">(</span><span class="nx">localTimestamp</span><span class="p">,</span> <span class="nx">remoteTimestamp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="crdtConflicts">
Conflict Resolution
<a class="anchor" href="https://docs.decentraland.org/contributor/runtime/modules/engine_api/#crdtConflicts">#</a>
</h4>
<p>When the CRDT encounters two competing states, it needs a shared resolution strategy that all parties apply identically, ensuring the same decision is reached by everyone. The Decentraland protocol uses very simple rules:</p>
<ol>
<li>If the entity was deleted (and the ID never reused), ignore new state.</li>
<li>If there was no prior state, keep the new state.</li>
<li>If the new state has a greater timestamp, keep the new state.</li>
<li>If the new state has a lesser timestamp, keep the old state.</li>
<li>If both timestamps are equal, compare the states byte-by-byte and keep the lower value.</li>
</ol>
<p>Most cases will be resolved by rules <code>1</code>, <code>2</code> and <code>3</code>.</p>
<h4 id="initial-synchronization">
Initial Synchronization
<a class="anchor" href="https://docs.decentraland.org/contributor/runtime/modules/engine_api/#initial-synchronization">#</a>
</h4>
<p>Before a scene starts running its own code, the runtime populates the CRDT with the state of all <a href="https://docs.decentraland.org/contributor/runtime/entities/">
basic entities
</a> and their components.</p>
<p>During this initial synchronization, only the runtime can set the shared state. The scene is not allowed to make modifications until the process is complete.</p>
<h4 id="messages">
Messaging Protocol
<a class="anchor" href="https://docs.decentraland.org/contributor/runtime/modules/engine_api/#messages">#</a>
</h4>
<p>Messages between the World Explorer and the scene runtime are structures in a serialized binary representation. Every message carries a header indicating the type and length, followed by a particular payload for each type of message.</p>
<div class="goat svg-container ">
<svg xmlns="http://www.w3.org/2000/svg" font-family="Menlo,Lucida Console,monospace" viewBox="0 0 808 73">
<g transform="translate(8,16)">
<path d="M 0,0 L 136,0" fill="none" stroke="currentColor"></path>
<path d="M 136,0 L 256,0" fill="none" stroke="currentColor"></path>
<path d="M 256,0 L 528,0" fill="none" stroke="currentColor"></path>
<path d="M 0,32 L 136,32" fill="none" stroke="currentColor"></path>
<path d="M 136,32 L 256,32" fill="none" stroke="currentColor"></path>
<path d="M 256,32 L 528,32" fill="none" stroke="currentColor"></path>
<path d="M 0,0 L 0,32" fill="none" stroke="currentColor"></path>
<path d="M 136,0 L 136,32" fill="none" stroke="currentColor"></path>
<path d="M 256,0 L 256,32" fill="none" stroke="currentColor"></path>
<path d="M 528,0 L 528,32" fill="none" stroke="currentColor"></path>
<text text-anchor="middle" x="0" y="52" fill="currentColor" style="font-size:1em">╵</text>
<text text-anchor="middle" x="16" y="20" fill="currentColor" style="font-size:1em">l</text>
<text text-anchor="middle" x="24" y="20" fill="currentColor" style="font-size:1em">e</text>
<text text-anchor="middle" x="32" y="20" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="40" y="20" fill="currentColor" style="font-size:1em">g</text>
<text text-anchor="middle" x="48" y="20" fill="currentColor" style="font-size:1em">t</text>
<text text-anchor="middle" x="56" y="20" fill="currentColor" style="font-size:1em">h</text>
<text text-anchor="middle" x="64" y="20" fill="currentColor" style="font-size:1em">:</text>
<text text-anchor="middle" x="80" y="20" fill="currentColor" style="font-size:1em">u</text>
<text text-anchor="middle" x="80" y="52" fill="currentColor" style="font-size:1em">c</text>
<text text-anchor="middle" x="88" y="20" fill="currentColor" style="font-size:1em">i</text>
<text text-anchor="middle" x="88" y="52" fill="currentColor" style="font-size:1em">o</text>
<text text-anchor="middle" x="96" y="20" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="96" y="52" fill="currentColor" style="font-size:1em">m</text>
<text text-anchor="middle" x="104" y="20" fill="currentColor" style="font-size:1em">t</text>
<text text-anchor="middle" x="104" y="52" fill="currentColor" style="font-size:1em">m</text>
<text text-anchor="middle" x="112" y="20" fill="currentColor" style="font-size:1em">3</text>
<text text-anchor="middle" x="112" y="52" fill="currentColor" style="font-size:1em">o</text>
<text text-anchor="middle" x="120" y="20" fill="currentColor" style="font-size:1em">2</text>
<text text-anchor="middle" x="120" y="52" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="136" y="52" fill="currentColor" style="font-size:1em">f</text>
<text text-anchor="middle" x="144" y="52" fill="currentColor" style="font-size:1em">i</text>
<text text-anchor="middle" x="152" y="20" fill="currentColor" style="font-size:1em">t</text>
<text text-anchor="middle" x="152" y="52" fill="currentColor" style="font-size:1em">e</text>
<text text-anchor="middle" x="160" y="20" fill="currentColor" style="font-size:1em">y</text>
<text text-anchor="middle" x="160" y="52" fill="currentColor" style="font-size:1em">l</text>
<text text-anchor="middle" x="168" y="20" fill="currentColor" style="font-size:1em">p</text>
<text text-anchor="middle" x="168" y="52" fill="currentColor" style="font-size:1em">d</text>
<text text-anchor="middle" x="176" y="20" fill="currentColor" style="font-size:1em">e</text>
<text text-anchor="middle" x="176" y="52" fill="currentColor" style="font-size:1em">s</text>
<text text-anchor="middle" x="184" y="20" fill="currentColor" style="font-size:1em">:</text>
<text text-anchor="middle" x="200" y="20" fill="currentColor" style="font-size:1em">u</text>
<text text-anchor="middle" x="208" y="20" fill="currentColor" style="font-size:1em">i</text>
<text text-anchor="middle" x="216" y="20" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="224" y="20" fill="currentColor" style="font-size:1em">t</text>
<text text-anchor="middle" x="232" y="20" fill="currentColor" style="font-size:1em">3</text>
<text text-anchor="middle" x="240" y="20" fill="currentColor" style="font-size:1em">2</text>
<text text-anchor="middle" x="256" y="52" fill="currentColor" style="font-size:1em">╵</text>
<text text-anchor="middle" x="304" y="20" fill="currentColor" style="font-size:1em">p</text>
<text text-anchor="middle" x="312" y="20" fill="currentColor" style="font-size:1em">a</text>
<text text-anchor="middle" x="320" y="20" fill="currentColor" style="font-size:1em">y</text>
<text text-anchor="middle" x="328" y="20" fill="currentColor" style="font-size:1em">l</text>
<text text-anchor="middle" x="336" y="20" fill="currentColor" style="font-size:1em">o</text>
<text text-anchor="middle" x="336" y="52" fill="currentColor" style="font-size:1em">t</text>
<text text-anchor="middle" x="344" y="20" fill="currentColor" style="font-size:1em">a</text>
<text text-anchor="middle" x="344" y="52" fill="currentColor" style="font-size:1em">y</text>
<text text-anchor="middle" x="352" y="20" fill="currentColor" style="font-size:1em">d</text>
<text text-anchor="middle" x="352" y="52" fill="currentColor" style="font-size:1em">p</text>
<text text-anchor="middle" x="360" y="20" fill="currentColor" style="font-size:1em">:</text>
<text text-anchor="middle" x="360" y="52" fill="currentColor" style="font-size:1em">e</text>
<text text-anchor="middle" x="368" y="52" fill="currentColor" style="font-size:1em">-</text>
<text text-anchor="middle" x="376" y="20" fill="currentColor" style="font-size:1em">b</text>
<text text-anchor="middle" x="376" y="52" fill="currentColor" style="font-size:1em">d</text>
<text text-anchor="middle" x="384" y="20" fill="currentColor" style="font-size:1em">y</text>
<text text-anchor="middle" x="384" y="52" fill="currentColor" style="font-size:1em">e</text>
<text text-anchor="middle" x="392" y="20" fill="currentColor" style="font-size:1em">t</text>
<text text-anchor="middle" x="392" y="52" fill="currentColor" style="font-size:1em">p</text>
<text text-anchor="middle" x="400" y="20" fill="currentColor" style="font-size:1em">e</text>
<text text-anchor="middle" x="400" y="52" fill="currentColor" style="font-size:1em">e</text>
<text text-anchor="middle" x="408" y="20" fill="currentColor" style="font-size:1em">[</text>
<text text-anchor="middle" x="408" y="52" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="416" y="20" fill="currentColor" style="font-size:1em">l</text>
<text text-anchor="middle" x="416" y="52" fill="currentColor" style="font-size:1em">d</text>
<text text-anchor="middle" x="424" y="20" fill="currentColor" style="font-size:1em">e</text>
<text text-anchor="middle" x="424" y="52" fill="currentColor" style="font-size:1em">e</text>
<text text-anchor="middle" x="432" y="20" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="432" y="52" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="440" y="20" fill="currentColor" style="font-size:1em">g</text>
<text text-anchor="middle" x="440" y="52" fill="currentColor" style="font-size:1em">t</text>
<text text-anchor="middle" x="448" y="20" fill="currentColor" style="font-size:1em">t</text>
<text text-anchor="middle" x="456" y="20" fill="currentColor" style="font-size:1em">h</text>
<text text-anchor="middle" x="464" y="20" fill="currentColor" style="font-size:1em">]</text>
<text text-anchor="middle" x="528" y="52" fill="currentColor" style="font-size:1em">╵</text>
</g>
</svg>
</div>
<p>There are three message types in the CRDT protocol:</p>
<ul>
<li><a href="https://docs.decentraland.org/contributor/runtime/modules/engine_api/#PutComponent">
<code>PutComponent</code>
</a></li>
<li><a href="https://docs.decentraland.org/contributor/runtime/modules/engine_api/#DeleteComponent">
<code>DeleteComponent</code>
</a></li>
<li><a href="https://docs.decentraland.org/contributor/runtime/modules/engine_api/#DeleteEntity">
<code>DeleteEntity</code>
</a></li>
</ul>
<p>Note that there are no <code>CreateComponent</code> or <code>CreateEntity</code> messages. The CRDT rules auto-create entities and components that weren’t previously known, as <a href="https://docs.decentraland.org/contributor/runtime/modules/engine_api/#crdtStateAutoCreate">
explained above
</a>.</p>
<h6 id="PutComponentMessage">
<code>PutComponentMessage</code>
<a class="anchor" href="https://docs.decentraland.org/contributor/runtime/modules/engine_api/#PutComponentMessage">#</a>
</h6>
<p>Update the <code>state</code> of a <code>component</code> for a particular <code>entity</code>, creating unknown components and entities in the CRDT if necessary. <a href="https://docs.decentraland.org/contributor/runtime/modules/engine_api/#crdtConflicts">
Resolve conflicts
</a> according to <code>timestamp</code>.</p>
<div class="goat svg-container ">
<svg xmlns="http://www.w3.org/2000/svg" font-family="Menlo,Lucida Console,monospace" viewBox="0 0 808 73">
<g transform="translate(8,16)">
<path d="M 0,0 L 136,0" fill="none" stroke="currentColor"></path>
<path d="M 136,0 L 296,0" fill="none" stroke="currentColor"></path>
<path d="M 296,0 L 648,0" fill="none" stroke="currentColor"></path>
<path d="M 0,32 L 136,32" fill="none" stroke="currentColor"></path>
<path d="M 136,32 L 296,32" fill="none" stroke="currentColor"></path>
<path d="M 296,32 L 648,32" fill="none" stroke="currentColor"></path>
<path d="M 0,0 L 0,32" fill="none" stroke="currentColor"></path>
<path d="M 136,0 L 136,32" fill="none" stroke="currentColor"></path>
<path d="M 296,0 L 296,32" fill="none" stroke="currentColor"></path>
<path d="M 648,0 L 648,32" fill="none" stroke="currentColor"></path>
<text text-anchor="middle" x="0" y="52" fill="currentColor" style="font-size:1em">╵</text>
<text text-anchor="middle" x="16" y="20" fill="currentColor" style="font-size:1em">e</text>
<text text-anchor="middle" x="24" y="20" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="32" y="20" fill="currentColor" style="font-size:1em">t</text>
<text text-anchor="middle" x="40" y="20" fill="currentColor" style="font-size:1em">i</text>
<text text-anchor="middle" x="48" y="20" fill="currentColor" style="font-size:1em">t</text>
<text text-anchor="middle" x="56" y="20" fill="currentColor" style="font-size:1em">y</text>
<text text-anchor="middle" x="64" y="20" fill="currentColor" style="font-size:1em">:</text>
<text text-anchor="middle" x="80" y="20" fill="currentColor" style="font-size:1em">u</text>
<text text-anchor="middle" x="88" y="20" fill="currentColor" style="font-size:1em">i</text>
<text text-anchor="middle" x="96" y="20" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="104" y="20" fill="currentColor" style="font-size:1em">t</text>
<text text-anchor="middle" x="112" y="20" fill="currentColor" style="font-size:1em">3</text>
<text text-anchor="middle" x="120" y="20" fill="currentColor" style="font-size:1em">2</text>
<text text-anchor="middle" x="152" y="20" fill="currentColor" style="font-size:1em">c</text>
<text text-anchor="middle" x="160" y="20" fill="currentColor" style="font-size:1em">o</text>
<text text-anchor="middle" x="168" y="20" fill="currentColor" style="font-size:1em">m</text>
<text text-anchor="middle" x="176" y="20" fill="currentColor" style="font-size:1em">p</text>
<text text-anchor="middle" x="184" y="20" fill="currentColor" style="font-size:1em">o</text>
<text text-anchor="middle" x="192" y="20" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="192" y="52" fill="currentColor" style="font-size:1em">c</text>
<text text-anchor="middle" x="200" y="20" fill="currentColor" style="font-size:1em">e</text>
<text text-anchor="middle" x="200" y="52" fill="currentColor" style="font-size:1em">o</text>
<text text-anchor="middle" x="208" y="20" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="208" y="52" fill="currentColor" style="font-size:1em">m</text>
<text text-anchor="middle" x="216" y="20" fill="currentColor" style="font-size:1em">t</text>
<text text-anchor="middle" x="216" y="52" fill="currentColor" style="font-size:1em">m</text>
<text text-anchor="middle" x="224" y="20" fill="currentColor" style="font-size:1em">:</text>
<text text-anchor="middle" x="224" y="52" fill="currentColor" style="font-size:1em">o</text>
<text text-anchor="middle" x="232" y="52" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="240" y="20" fill="currentColor" style="font-size:1em">u</text>
<text text-anchor="middle" x="248" y="20" fill="currentColor" style="font-size:1em">i</text>
<text text-anchor="middle" x="248" y="52" fill="currentColor" style="font-size:1em">f</text>
<text text-anchor="middle" x="256" y="20" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="256" y="52" fill="currentColor" style="font-size:1em">i</text>
<text text-anchor="middle" x="264" y="20" fill="currentColor" style="font-size:1em">t</text>
<text text-anchor="middle" x="264" y="52" fill="currentColor" style="font-size:1em">e</text>
<text text-anchor="middle" x="272" y="20" fill="currentColor" style="font-size:1em">3</text>
<text text-anchor="middle" x="272" y="52" fill="currentColor" style="font-size:1em">l</text>
<text text-anchor="middle" x="280" y="20" fill="currentColor" style="font-size:1em">2</text>
<text text-anchor="middle" x="280" y="52" fill="currentColor" style="font-size:1em">d</text>
<text text-anchor="middle" x="288" y="52" fill="currentColor" style="font-size:1em">s</text>
<text text-anchor="middle" x="312" y="20" fill="currentColor" style="font-size:1em">t</text>
<text text-anchor="middle" x="320" y="20" fill="currentColor" style="font-size:1em">i</text>
<text text-anchor="middle" x="328" y="20" fill="currentColor" style="font-size:1em">m</text>
<text text-anchor="middle" x="336" y="20" fill="currentColor" style="font-size:1em">e</text>
<text text-anchor="middle" x="344" y="20" fill="currentColor" style="font-size:1em">s</text>
<text text-anchor="middle" x="352" y="20" fill="currentColor" style="font-size:1em">t</text>
<text text-anchor="middle" x="360" y="20" fill="currentColor" style="font-size:1em">a</text>
<text text-anchor="middle" x="368" y="20" fill="currentColor" style="font-size:1em">m</text>
<text text-anchor="middle" x="376" y="20" fill="currentColor" style="font-size:1em">p</text>
<text text-anchor="middle" x="384" y="20" fill="currentColor" style="font-size:1em">:</text>
<text text-anchor="middle" x="400" y="20" fill="currentColor" style="font-size:1em">u</text>
<text text-anchor="middle" x="408" y="20" fill="currentColor" style="font-size:1em">i</text>
<text text-anchor="middle" x="416" y="20" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="424" y="20" fill="currentColor" style="font-size:1em">t</text>
<text text-anchor="middle" x="432" y="20" fill="currentColor" style="font-size:1em">3</text>
<text text-anchor="middle" x="440" y="20" fill="currentColor" style="font-size:1em">2</text>
<text text-anchor="middle" x="456" y="20" fill="currentColor" style="font-size:1em">|</text>
<text text-anchor="middle" x="456" y="52" fill="currentColor" style="font-size:1em">╵</text>
<text text-anchor="middle" x="480" y="52" fill="currentColor" style="font-size:1em">c</text>
<text text-anchor="middle" x="488" y="52" fill="currentColor" style="font-size:1em">o</text>
<text text-anchor="middle" x="496" y="52" fill="currentColor" style="font-size:1em">m</text>
<text text-anchor="middle" x="504" y="20" fill="currentColor" style="font-size:1em">s</text>
<text text-anchor="middle" x="504" y="52" fill="currentColor" style="font-size:1em">p</text>
<text text-anchor="middle" x="512" y="20" fill="currentColor" style="font-size:1em">t</text>
<text text-anchor="middle" x="512" y="52" fill="currentColor" style="font-size:1em">o</text>
<text text-anchor="middle" x="520" y="20" fill="currentColor" style="font-size:1em">a</text>
<text text-anchor="middle" x="520" y="52" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="528" y="20" fill="currentColor" style="font-size:1em">t</text>
<text text-anchor="middle" x="528" y="52" fill="currentColor" style="font-size:1em">e</text>
<text text-anchor="middle" x="536" y="20" fill="currentColor" style="font-size:1em">e</text>
<text text-anchor="middle" x="536" y="52" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="544" y="20" fill="currentColor" style="font-size:1em">:</text>
<text text-anchor="middle" x="544" y="52" fill="currentColor" style="font-size:1em">t</text>
<text text-anchor="middle" x="552" y="52" fill="currentColor" style="font-size:1em">-</text>
<text text-anchor="middle" x="560" y="20" fill="currentColor" style="font-size:1em">b</text>
<text text-anchor="middle" x="560" y="52" fill="currentColor" style="font-size:1em">d</text>
<text text-anchor="middle" x="568" y="20" fill="currentColor" style="font-size:1em">y</text>
<text text-anchor="middle" x="568" y="52" fill="currentColor" style="font-size:1em">e</text>
<text text-anchor="middle" x="576" y="20" fill="currentColor" style="font-size:1em">t</text>
<text text-anchor="middle" x="576" y="52" fill="currentColor" style="font-size:1em">p</text>
<text text-anchor="middle" x="584" y="20" fill="currentColor" style="font-size:1em">e</text>
<text text-anchor="middle" x="584" y="52" fill="currentColor" style="font-size:1em">e</text>
<text text-anchor="middle" x="592" y="20" fill="currentColor" style="font-size:1em">[</text>
<text text-anchor="middle" x="592" y="52" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="600" y="20" fill="currentColor" style="font-size:1em">]</text>
<text text-anchor="middle" x="600" y="52" fill="currentColor" style="font-size:1em">d</text>
<text text-anchor="middle" x="608" y="52" fill="currentColor" style="font-size:1em">e</text>
<text text-anchor="middle" x="616" y="52" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="624" y="52" fill="currentColor" style="font-size:1em">t</text>
<text text-anchor="middle" x="648" y="52" fill="currentColor" style="font-size:1em">╵</text>
</g>
</svg>
</div>
<p>The <code>state</code> field is a component-defined binary serialization. Most components use <a href="https://protobuf.dev/" target="_blank">
protocol buffers
</a> to encode messages as specified in the <code>.proto</code> files of <a href="https://github.com/decentraland/protocol" target="_blank">
the Decentraland protocol package
</a>. The notable exception to this rule is the <code>Transform</code> component, which (being the most common by far) has an optimized serialization format.</p>
<p>This additional layer of serialization has an important advantage: the CRDT protocol is agnostic to any present or future component implementations.</p>
<p>If the update contained in this message is applied to the CRDT, the <code>state</code> field is copied as-is into the structure.</p>
<h6 id="DeleteComponentMessage">
<code>DeleteComponentMessage</code>
<a class="anchor" href="https://docs.decentraland.org/contributor/runtime/modules/engine_api/#DeleteComponentMessage">#</a>
</h6>
<p>Remove the state of <code>component</code> for an <code>entity</code>. <a href="https://docs.decentraland.org/contributor/runtime/modules/engine_api/#crdtConflicts">
Resolve conflicts
</a> according to <code>timestamp</code>.</p>
<div class="goat svg-container ">
<svg xmlns="http://www.w3.org/2000/svg" font-family="Menlo,Lucida Console,monospace" viewBox="0 0 808 57">
<g transform="translate(8,16)">
<path d="M 0,0 L 136,0" fill="none" stroke="currentColor"></path>
<path d="M 136,0 L 296,0" fill="none" stroke="currentColor"></path>
<path d="M 296,0 L 456,0" fill="none" stroke="currentColor"></path>
<path d="M 0,32 L 136,32" fill="none" stroke="currentColor"></path>
<path d="M 136,32 L 296,32" fill="none" stroke="currentColor"></path>
<path d="M 296,32 L 456,32" fill="none" stroke="currentColor"></path>
<path d="M 0,0 L 0,32" fill="none" stroke="currentColor"></path>
<path d="M 136,0 L 136,32" fill="none" stroke="currentColor"></path>
<path d="M 296,0 L 296,32" fill="none" stroke="currentColor"></path>
<path d="M 456,0 L 456,32" fill="none" stroke="currentColor"></path>
<text text-anchor="middle" x="16" y="20" fill="currentColor" style="font-size:1em">e</text>
<text text-anchor="middle" x="24" y="20" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="32" y="20" fill="currentColor" style="font-size:1em">t</text>
<text text-anchor="middle" x="40" y="20" fill="currentColor" style="font-size:1em">i</text>
<text text-anchor="middle" x="48" y="20" fill="currentColor" style="font-size:1em">t</text>
<text text-anchor="middle" x="56" y="20" fill="currentColor" style="font-size:1em">y</text>
<text text-anchor="middle" x="64" y="20" fill="currentColor" style="font-size:1em">:</text>
<text text-anchor="middle" x="80" y="20" fill="currentColor" style="font-size:1em">u</text>
<text text-anchor="middle" x="88" y="20" fill="currentColor" style="font-size:1em">i</text>
<text text-anchor="middle" x="96" y="20" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="104" y="20" fill="currentColor" style="font-size:1em">t</text>
<text text-anchor="middle" x="112" y="20" fill="currentColor" style="font-size:1em">3</text>
<text text-anchor="middle" x="120" y="20" fill="currentColor" style="font-size:1em">2</text>
<text text-anchor="middle" x="152" y="20" fill="currentColor" style="font-size:1em">c</text>
<text text-anchor="middle" x="160" y="20" fill="currentColor" style="font-size:1em">o</text>
<text text-anchor="middle" x="168" y="20" fill="currentColor" style="font-size:1em">m</text>
<text text-anchor="middle" x="176" y="20" fill="currentColor" style="font-size:1em">p</text>
<text text-anchor="middle" x="184" y="20" fill="currentColor" style="font-size:1em">o</text>
<text text-anchor="middle" x="192" y="20" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="200" y="20" fill="currentColor" style="font-size:1em">e</text>
<text text-anchor="middle" x="208" y="20" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="216" y="20" fill="currentColor" style="font-size:1em">t</text>
<text text-anchor="middle" x="224" y="20" fill="currentColor" style="font-size:1em">:</text>
<text text-anchor="middle" x="240" y="20" fill="currentColor" style="font-size:1em">u</text>
<text text-anchor="middle" x="248" y="20" fill="currentColor" style="font-size:1em">i</text>
<text text-anchor="middle" x="256" y="20" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="264" y="20" fill="currentColor" style="font-size:1em">t</text>
<text text-anchor="middle" x="272" y="20" fill="currentColor" style="font-size:1em">3</text>
<text text-anchor="middle" x="280" y="20" fill="currentColor" style="font-size:1em">2</text>
<text text-anchor="middle" x="312" y="20" fill="currentColor" style="font-size:1em">t</text>
<text text-anchor="middle" x="320" y="20" fill="currentColor" style="font-size:1em">i</text>
<text text-anchor="middle" x="328" y="20" fill="currentColor" style="font-size:1em">m</text>
<text text-anchor="middle" x="336" y="20" fill="currentColor" style="font-size:1em">e</text>
<text text-anchor="middle" x="344" y="20" fill="currentColor" style="font-size:1em">s</text>
<text text-anchor="middle" x="352" y="20" fill="currentColor" style="font-size:1em">t</text>
<text text-anchor="middle" x="360" y="20" fill="currentColor" style="font-size:1em">a</text>
<text text-anchor="middle" x="368" y="20" fill="currentColor" style="font-size:1em">m</text>
<text text-anchor="middle" x="376" y="20" fill="currentColor" style="font-size:1em">p</text>
<text text-anchor="middle" x="384" y="20" fill="currentColor" style="font-size:1em">:</text>
<text text-anchor="middle" x="400" y="20" fill="currentColor" style="font-size:1em">u</text>
<text text-anchor="middle" x="408" y="20" fill="currentColor" style="font-size:1em">i</text>
<text text-anchor="middle" x="416" y="20" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="424" y="20" fill="currentColor" style="font-size:1em">t</text>
<text text-anchor="middle" x="432" y="20" fill="currentColor" style="font-size:1em">3</text>
<text text-anchor="middle" x="440" y="20" fill="currentColor" style="font-size:1em">2</text>
</g>
</svg>
</div>
<h6 id="DeleteEntityMessage">
<code>DeleteEntityMessage</code>
<a class="anchor" href="https://docs.decentraland.org/contributor/runtime/modules/engine_api/#DeleteEntityMessage">#</a>
</h6>
<p>Delete <code>entity</code> (i.e. all associated component state), expecting the identifier to never be reused for a different entity.</p>
<div class="goat svg-container ">
<svg xmlns="http://www.w3.org/2000/svg" font-family="Menlo,Lucida Console,monospace" viewBox="0 0 808 57">
<g transform="translate(8,16)">
<path d="M 0,0 L 136,0" fill="none" stroke="currentColor"></path>
<path d="M 0,32 L 136,32" fill="none" stroke="currentColor"></path>
<path d="M 0,0 L 0,32" fill="none" stroke="currentColor"></path>
<path d="M 136,0 L 136,32" fill="none" stroke="currentColor"></path>
<text text-anchor="middle" x="16" y="20" fill="currentColor" style="font-size:1em">e</text>
<text text-anchor="middle" x="24" y="20" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="32" y="20" fill="currentColor" style="font-size:1em">t</text>
<text text-anchor="middle" x="40" y="20" fill="currentColor" style="font-size:1em">i</text>
<text text-anchor="middle" x="48" y="20" fill="currentColor" style="font-size:1em">t</text>
<text text-anchor="middle" x="56" y="20" fill="currentColor" style="font-size:1em">y</text>
<text text-anchor="middle" x="64" y="20" fill="currentColor" style="font-size:1em">:</text>
<text text-anchor="middle" x="80" y="20" fill="currentColor" style="font-size:1em">u</text>
<text text-anchor="middle" x="88" y="20" fill="currentColor" style="font-size:1em">i</text>
<text text-anchor="middle" x="96" y="20" fill="currentColor" style="font-size:1em">n</text>
<text text-anchor="middle" x="104" y="20" fill="currentColor" style="font-size:1em">t</text>
<text text-anchor="middle" x="112" y="20" fill="currentColor" style="font-size:1em">3</text>
<text text-anchor="middle" x="120" y="20" fill="currentColor" style="font-size:1em">2</text>
</g>
</svg>
</div>
<p>Note that there is no <code>timestamp</code> field. Since the lifespan of <code>entity</code> is over, the conflict resolution strategy for any out-of-order updates is to simply ignore them.</p>
<h2 id="methods">
Methods
<a class="anchor" href="https://docs.decentraland.org/contributor/runtime/modules/engine_api/#methods">#</a>
</h2>
<p>The set of methods in <code>EngineApi</code> provide the interface to exchange messages and reconstruct the state of the world from scratch.</p>
<h6 id="crdtSendToRenderer">
<code>crdtSendToRenderer</code>
<a class="anchor" href="https://docs.decentraland.org/contributor/runtime/modules/engine_api/#crdtSendToRenderer">#</a>
</h6>
<p>Send a serialized message from the scene to the renderer, return an array of serialized messages that the renderer has for the scene.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">interface</span> <span class="nx">Request</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// The serialized message for this request:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">data</span>: <span class="kt">byte</span><span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">interface</span> <span class="nx">Response</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// An array of serialized messages from the renderer (if any):
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">data</span>: <span class="kt">byte</span><span class="p">[][]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">crdtSendToRenderer</span><span class="p">(</span><span class="nx">Request</span><span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="p">&lt;</span><span class="nt">Response</span><span class="p">&gt;</span>
</span></span></code></pre></div><h6 id="crdtGetState">
<code>crdtGetState</code>
<a class="anchor" href="https://docs.decentraland.org/contributor/runtime/modules/engine_api/#crdtGetState">#</a>
</h6>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">interface</span> <span class="nx">Request</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">interface</span> <span class="nx">Response</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Whether the state has scene-created entities:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">hasEntities</span>: <span class="kt">boolean</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// An array of messages that can reconstruct the CRDT state:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">data</span>: <span class="kt">byte</span><span class="p">[][]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">crdtGetState</span><span class="p">(</span><span class="nx">Request</span><span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="p">&lt;</span><span class="nt">Response</span><span class="p">&gt;</span>
</span></span></code></pre></div><h2 id="legacy-scenes">
Legacy Scenes
<a class="anchor" href="https://docs.decentraland.org/contributor/runtime/modules/engine_api/#legacy-scenes">#</a>
</h2>
<p>Old-style scenes (i.e. those built using the SDK version 6 or older) don’t use the modern CRDT mechanism, instead calling methods in <code>EngineApi</code> that are now deprecated.</p>
<p>Support for these scenes is not a requirement for a protocol-compliant Decentraland application.</p>
</article>
<footer class="book-footer">
<div class="flex flex-wrap justify-between">
<div><a class="flex align-center" href="https://github.com/decentraland/documentation/commit/86dbc267b62c3ff66b32b916ace28b735033bc59" title="Last modified by Gabriel Díaz | April 26, 2024" target="_blank" rel="noopener">
<img src="./EngineApi _ Decentraland Documentation_files/calendar.svg" class="book-icon" alt="Calendar">
<span>April 26, 2024</span>
</a>
</div>
<div>
<a class="flex align-center" href="https://github.com/decentraland/documentation/edit/main/content/contributor/runtime/modules/engine_api.md" target="_blank" rel="noopener">
<img src="./EngineApi _ Decentraland Documentation_files/edit.svg" class="book-icon" alt="Edit">
<span>Edit this page</span>
</a>
</div>
</div>
<script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>
</footer>
<label for="menu-control" class="hidden book-menu-overlay"></label>
</div>
</main>
<div class="ui container dcl footer">
<div class="main-footer">
<div role="listbox" aria-expanded="false" class="ui upward dropdown dcl language-dropdown" tabindex="0">
<div aria-atomic="true" aria-live="polite" role="alert" class="divider text">
<div class="dcl language-icon-wrapper">
<i class="dcl language-icon en"> </i>
<div class="language-icon-label">English</div>
</div>
</div>
</div>
<div class="links">
<a href="https://decentraland.org/">Home</a>
<a href="https://decentraland.org/privacy">Privacy Policy</a>
<a href="https://decentraland.org/terms">Terms of Use</a>
<a href="https://decentraland.org/content">Content Policy</a>
<a href="https://decentraland.org/ethics">Code of Ethics</a>
</div>
</div>
<div class="secondary-footer">
<div class="social-links">
<a href="https://dcl.gg/discord">
<i class="social-icon discord"></i>
</a>
<a href="https://reddit.com/r/decentraland">
<i class="social-icon reddit"></i>
</a>
<a href="https://github.com/decentraland">
<i class="social-icon github"></i>
</a>
<a href="https://twitter.com/decentraland">
<i class="social-icon twitter"></i>
</a>
</div>
<div class="copyright">© 2023 Decentraland</div>
</div>
</div>
<script defer="" src="./EngineApi _ Decentraland Documentation_files/beacon.min.js.download" data-cf-beacon="{&quot;token&quot;: &quot;ef470b4862c74992aaa278b7c4d4c969&quot;}"></script>

<iframe id="intercom-frame" style="position: absolute !important; opacity: 0 !important; width: 1px !important; height: 1px !important; top: 0 !important; left: 0 !important; border: none !important; display: block !important; z-index: -1 !important; pointer-events: none;" aria-hidden="true" tabindex="-1" title="Intercom" src="./EngineApi _ Decentraland Documentation_files/saved_resource.html"></iframe><div class="intercom-lightweight-app"><div class="intercom-lightweight-app-launcher intercom-launcher" role="button" tabindex="0" aria-label="Open Intercom Messenger" aria-live="polite"><div class="intercom-lightweight-app-launcher-icon intercom-lightweight-app-launcher-icon-open"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 32"><path d="M28 32s-4.714-1.855-8.527-3.34H3.437C1.54 28.66 0 27.026 0 25.013V3.644C0 1.633 1.54 0 3.437 0h21.125c1.898 0 3.437 1.632 3.437 3.645v18.404H28V32zm-4.139-11.982a.88.88 0 00-1.292-.105c-.03.026-3.015 2.681-8.57 2.681-5.486 0-8.517-2.636-8.571-2.684a.88.88 0 00-1.29.107 1.01 1.01 0 00-.219.708.992.992 0 00.318.664c.142.128 3.537 3.15 9.762 3.15 6.226 0 9.621-3.022 9.763-3.15a.992.992 0 00.317-.664 1.01 1.01 0 00-.218-.707z"></path></svg></div><div class="intercom-lightweight-app-launcher-icon intercom-lightweight-app-launcher-icon-minimize"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path fill-rule="evenodd" clip-rule="evenodd" d="M18.601 8.39897C18.269 8.06702 17.7309 8.06702 17.3989 8.39897L12 13.7979L6.60099 8.39897C6.26904 8.06702 5.73086 8.06702 5.39891 8.39897C5.06696 8.73091 5.06696 9.2691 5.39891 9.60105L11.3989 15.601C11.7309 15.933 12.269 15.933 12.601 15.601L18.601 9.60105C18.9329 9.2691 18.9329 8.73091 18.601 8.39897Z" fill="white"></path>
</svg>
</div></div><style id="intercom-lightweight-app-style" type="text/css">
  @keyframes intercom-lightweight-app-launcher {
    from {
      opacity: 0;
      transform: scale(0.5);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  @keyframes intercom-lightweight-app-gradient {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  @keyframes intercom-lightweight-app-messenger {
    0% {
      opacity: 0;
      transform: scale(0);
    }
    40% {
      opacity: 1;
    }
    100% {
      transform: scale(1);
    }
  }

  .intercom-lightweight-app {
    position: fixed;
    z-index: 2147483001;
    width: 0;
    height: 0;
    font-family: intercom-font, "Helvetica Neue", "Apple Color Emoji", Helvetica, Arial, sans-serif;
  }

  .intercom-lightweight-app-gradient {
    position: fixed;
    z-index: 2147483002;
    width: 500px;
    height: 500px;
    bottom: 0;
    right: 0;
    pointer-events: none;
    background: radial-gradient(
      ellipse at bottom right,
      rgba(29, 39, 54, 0.16) 0%,
      rgba(29, 39, 54, 0) 72%);
    animation: intercom-lightweight-app-gradient 200ms ease-out;
  }

  .intercom-lightweight-app-launcher {
    position: fixed;
    z-index: 2147483003;
    padding: 0 !important;
    margin: 0 !important;
    border: none;
    bottom: 20px;
    right: 20px;
    max-width: 48px;
    width: 48px;
    max-height: 48px;
    height: 48px;
    border-radius: 50%;
    background: #FF2D55;
    cursor: pointer;
    box-shadow: 0 1px 6px 0 rgba(0, 0, 0, 0.06), 0 2px 32px 0 rgba(0, 0, 0, 0.16);
    transition: transform 167ms cubic-bezier(0.33, 0.00, 0.00, 1.00);
    box-sizing: content-box;
  }


  .intercom-lightweight-app-launcher:hover {
    transition: transform 250ms cubic-bezier(0.33, 0.00, 0.00, 1.00);
    transform: scale(1.1)
  }

  .intercom-lightweight-app-launcher:active {
    transform: scale(0.85);
    transition: transform 134ms cubic-bezier(0.45, 0, 0.2, 1);
  }


  .intercom-lightweight-app-launcher:focus {
    outline: none;

    
  }

  .intercom-lightweight-app-launcher-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    position: absolute;
    top: 0;
    left: 0;
    width: 48px;
    height: 48px;
    transition: transform 100ms linear, opacity 80ms linear;
  }

  .intercom-lightweight-app-launcher-icon-open {
    
        opacity: 1;
        transform: rotate(0deg) scale(1);
      
  }

  .intercom-lightweight-app-launcher-icon-open svg {
    width: 24px;
    height: 24px;
  }

  .intercom-lightweight-app-launcher-icon-open svg path {
    fill: rgb(255, 255, 255);
  }

  .intercom-lightweight-app-launcher-icon-self-serve {
    
        opacity: 1;
        transform: rotate(0deg) scale(1);
      
  }

  .intercom-lightweight-app-launcher-icon-self-serve svg {
    height: 44px;
  }

  .intercom-lightweight-app-launcher-icon-self-serve svg path {
    fill: rgb(255, 255, 255);
  }

  .intercom-lightweight-app-launcher-custom-icon-open {
    max-height: 24px;
    max-width: 24px;

    
        opacity: 1;
        transform: rotate(0deg) scale(1);
      
  }

  .intercom-lightweight-app-launcher-icon-minimize {
    
        opacity: 0;
        transform: rotate(-60deg) scale(0);
      
  }

  .intercom-lightweight-app-launcher-icon-minimize svg path {
    fill: rgb(255, 255, 255);
  }

  .intercom-lightweight-app-messenger {
    position: fixed;
    z-index: 2147483003;
    overflow: hidden;
    background-color: white;
    animation: intercom-lightweight-app-messenger 250ms cubic-bezier(0, 1, 1, 1);
    transform-origin: bottom right;

    
        width: 400px;
        height: calc(100% - 104px);
        max-height: 704px;
        min-height: 250px;
        right: 20px;
        bottom: 84px;
        box-shadow: 0 5px 40px rgba(0,0,0,0.16);
      

    border-radius: 16px;
  }

  .intercom-lightweight-app-messenger-header {
    height: 64px;
    border-bottom: none;
    background: #FF2D55

    
  }

  .intercom-lightweight-app-messenger-footer{
    position:absolute;
    bottom:0;
    width: 100%;
    height: 80px;
    background: #fff;
    font-size: 14px;
    line-height: 21px;
    border-top: 1px solid rgba(0, 0, 0, 0.05);
    box-shadow: 0px 0px 25px rgba(0, 0, 0, 0.05);
    
  }

  @media print {
    .intercom-lightweight-app {
      display: none;
    }
  }
</style></div></body></html>